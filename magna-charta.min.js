/*! Magna Charta - v0.5.0 - 2012-11-15
* https://github.com/alphagov/magna-charta
 */
(function(e){var t=function(){this.init=function(t,n){var r={outOf:65,applyOnInit:!0};return this.options=e.extend({},r,n),this.DISABLED=!!e("html.lte-ie8").length,this.$table=t,this.options.stacked=this.$table.hasClass("mc-stacked"),this.options.negative=this.$table.hasClass("mc-negative"),this.$bodyRows=this.$table.find("tr"),!this.DISABLED&&this.options.applyOnInit&&this.apply(),this},this.apply=function(){this.DISABLED||(this.addClasses(),this.applyWidths())},this.revert=function(){this.DISABLED||(this.restoreText(),this.removeWidths(),this.removeClasses())},this.removeClasses=function(){this.$table.removeClass("mc-table").find(".mc-key-cell, .mc-row, .mc-bar-cell, .mc-bar-negative, .mc-bar-positive").removeClass("mc-key-cell mc-row mc-bar-cell .mc-bar-negative .mc-bar-positive")},this.removeWidths=function(){this.$table.find(".mc-bar-cell").css("width","").css("margin-left","")},this.utils={isFloat:function(e){return!isNaN(parseFloat(e))},stripValue:function(e){return e.replace("%","").replace("Â£","").replace("m","")},returnMax:function(e){var t=0;for(var n=0;n<e.length;n++)e[n]>t&&(t=e[n]);return t},isNegative:function(e){return e<0}},this.addClasses=function(){this.$table.addClass("mc-table")},this.calculateMaxWidth=function(){var t=this,n=[],r=0;this.$bodyRows.each(function(i,s){var o=e(s),u=o.find("td:not(:first)");if(t.options.stacked){var a=u.last().addClass("mc-stacked-total");u=u.filter(":not(:last)")}var f=o.find("th:not(:first, .total)").addClass("mc-key-cell");o.find("td:first").addClass("mc-key-cell");var l=0;u.each(function(i,s){var o=e(s).addClass("mc-bar-cell"),u=t.utils.stripValue(o.text());if(t.utils.isFloat(u)){var a=parseFloat(u,10),f=Math.abs(a);t.options.negative&&(t.utils.isNegative(a)?(o.addClass("mc-bar-negative"),f>r&&(r=f)):o.addClass("mc-bar-positive")),a=f,t.options.stacked?l+=a:(l=a,n.push(a))}}),t.options.stacked&&n.push(l)});var i={};return i.max=parseFloat(t.utils.returnMax(n),10),i.single=parseFloat(this.options.outOf/i.max,10),this.options.negative&&(i.marginLeft=parseFloat(r,10)*i.single,i.maxNegative=parseFloat(r,10)),i},this.restoreText=function(){e(".mc-bar-cell").each(function(t,n){var r=e(n),i=r.data("oldText");i&&r.text(i)})},this.applyWidths=function(){this.restoreText(),this.dimensions=this.calculateMaxWidth();var t=this;this.$bodyRows.each(function(n,r){var i=e(r);i.find(".mc-bar-cell").each(function(n,r){var i=e(r),s=parseFloat(t.utils.stripValue(i.text()),10),o=s*t.dimensions.single,u=Math.abs(s),a=Math.abs(o);if(t.options.negative)if(i.hasClass("mc-bar-positive"))e(r).css("margin-left",t.dimensions.marginLeft+"%");else if(u<t.dimensions.maxNegative){var f=(t.dimensions.maxNegative-u)*t.dimensions.single;i.css("margin-left",f+"%")}i.css("width",a+"%"),i.data("oldText",i.text()),i.text(u)})})}};e.magnaCharta=function(e,n){return(new t).init(e,n)}})(jQuery);